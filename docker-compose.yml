services:
  geopagos.gateway.app:
    image: ${DOCKER_REGISTRY-}geopagosgatewayapp
    container_name: services-gateway
    hostname: services-gateway
    build:
      context: .
      dockerfile: GeoPagos.Gateway.App/Dockerfile
    networks:
      - geopagos-network

  geopagos.authorization.api:
    image: ${DOCKER_REGISTRY-}geopagosauthorizationapi
    container_name: services-authorization
    hostname: services-authorization
    build:
      context: .
      dockerfile: GeoPagos.Authorization.Api/Dockerfile
    networks:
      - geopagos-network


  geopagos.paymentprocessor.api:
    image: ${DOCKER_REGISTRY-}geopagospaymentprocessorapi
    container_name: services-payment-processor  
    hostname: services-payment-processor
    build:
      context: .
      dockerfile: GeoPagos.PaymentProcessor.Api/Dockerfile
    networks:
      - geopagos-network

  consul:
    image: consul:1.15.0  # Usar una version especifica
    container_name: services-consul 
    hostname: services-consul
    ports:
      - "8500:8500"  
    volumes:
      - consul-data:/consul/data
    networks:
      - geopagos-network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: services-rabbitmq
    hostname: services-rabbitmq
    ports:
      - "5672:5672" # Puerto para comunicacion con aplicaciones (AMQP)
      - "15672:15672" # Puerto para la interfaz web 
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    networks:
      - geopagos-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node  # Para usar Elasticsearch en un solo nodo
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.authc.api_key.enabled=true
      - ELASTIC_PASSWORD=kibana_password  # Pass para el usuario "elastic"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"  # Puerto HTTP para interactuar con Elasticsearch
      - "9300:9300"  # Puerto para la comunicacion interna entre nodos
    networks:
      - geopagos-network 

  kibana:
     image: docker.elastic.co/kibana/kibana:8.17.0
     container_name: kibana
     environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        - ELASTICSEARCH_USERNAME=kibana_user
        - ELASTICSEARCH_PASSWORD=kibana_password     
     ports:
        - "5601:5601"  # Puerto de Kibana para acceder a la interfaz web
     volumes:
      - sql_data:/var/opt/mssql  # Mapea el volumen persistente a la ruta donde SQL Server guarda los datos
     networks:
      - geopagos-network 
     depends_on:
        - elasticsearch

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver 
    environment:
      - NAME=AuthorizationDb
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=MyP@ssw0rd2025
    ports:
      - "1434:1433"
    networks:
      - geopagos-network 
    restart: always 




volumes:
  consul-data:
  es_data:
    driver: local
  sql_data:

networks:
  geopagos-network:  